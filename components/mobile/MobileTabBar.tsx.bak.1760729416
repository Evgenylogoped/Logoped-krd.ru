"use client"
import Link from "next/link"
import { useSession } from "next-auth/react"
import { useEffect, useState } from "react"
import { usePathname } from "next/navigation"

export default function MobileTabBar({ role: roleProp }: { role?: string } = {}) {
  const { data } = useSession()
  const role = (roleProp as any) ?? ((data?.user as any)?.role as string | undefined)
  const R = (role || "").toUpperCase()
  const isParent = R === "PARENT"
  const isLogoped = R === "LOGOPED"
  const roleLeader = ["ADMIN","ACCOUNTANT","SUPER_ADMIN","SUPERVISOR","OWNER","LEADER","MANAGER","ORGANIZER"].includes(R)
  const [mounted, setMounted] = useState(false)
  const [leaderFlag, setLeaderFlag] = useState<boolean | null>(null)
  const [moreOpen, setMoreOpen] = useState(false)
  const pathname = usePathname()
  const showLeader = (leaderFlag===true) || (leaderFlag===null && roleLeader && !isLogoped && !isParent)
  useEffect(() => setMounted(true), [])
  useEffect(() => {
    let alive=true;
    if (!mounted) return;
    fetch("/api/me/leader-flags").then(r=>r.json()).then(j=>{ if(alive) setLeaderFlag(Boolean(j?.isLeader)) }).catch(()=>{});
    return ()=>{alive=false};
  }, [mounted])
  if (!mounted) return null

  const wrapClass = "fixed bottom-0 inset-x-0 z-20 border-t md:hidden"
  const commonClass = "flex flex-col items-center justify-center gap-1 py-2 text-[11px] rounded-xl border text-muted hover:bg-gray-50 active:scale-[0.98] transition"
  const activeClass = "text-blue-800 font-extrabold border-blue-700 bg-blue-100 ring-2 ring-blue-300 shadow"
  function linkClass(href: string){
    const ok = pathname && (pathname===href || pathname.startsWith(href+'/'))
    return commonClass + (ok ? ' ' + activeClass : '')
  }

  function MenuPanel(){
    const sections: { title: string, items: { href: string, label: string }[] }[] = []
    if (showLeader) {
      sections.push({ title: '–†—É–∫. —Ñ–∏–Ω–∞–Ω—Å—ã', items: [
        { href: '/logoped/finance', label: '–õ–∏—á. —Ñ–∏–Ω–∞–Ω—Å—ã' },
        { href: '/admin/finance/dashboard', label: '–î–∞—à–±–æ—Ä–¥' },
        { href: '/admin/finance/children', label: '–î–µ—Ç–∏' },
        { href: '/admin/finance/payouts', label: '–í—ã–ø–ª–∞—Ç—ã' },
        { href: '/admin/finance/passes', label: '–ê–±–æ–Ω–µ–º–µ–Ω—Ç' },
        { href: '/admin/finance/statistics', label: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' },
        { href: '/admin/finance/archive', label: '–ê—Ä—Ö–∏–≤' },
      ]})
      sections.push({ title: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', items: [
        { href: '/settings/profile', label: '–ü—Ä–æ—Ñ–∏–ª—å' },
        { href: '/settings/password', label: '–ü–∞—Ä–æ–ª—å' },
        { href: '/settings/billing', label: '–ü–æ–¥–ø–∏—Å–∫–∞' },
        { href: '/settings/schedule/template', label: '–®–∞–±–ª–æ–Ω –Ω–µ–¥–µ–ª–∏' },
      ]})
      sections.push({ title: '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è', items: [
        { href: '/admin/organizations', label: '–ö–æ–º–ø–∞–Ω–∏—è –∏ —Ñ–∏–ª–∏–∞–ª—ã' },
        { href: '/admin/organization/request', label: '–ó–∞—è–≤–∫–∞ –Ω–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é' },
        { href: '/admin/organization/membership', label: '–ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ' },
        { href: '/admin/org-requests', label: '–í—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã' },
      ]})
    } else if (isLogoped) {
      sections.push({ title: '–§–∏–Ω–∞–Ω—Å—ã', items: [
        { href: '/logoped/finance', label: '–õ–∏—á. —Ñ–∏–Ω–∞–Ω—Å—ã' },
        { href: '/logoped/org-finance', label: '–õ–æ–≥. —Ñ–∏–Ω–∞–Ω—Å—ã' },
      ]})
      sections.push({ title: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', items: [
        { href: '/settings/profile', label: '–ü—Ä–æ—Ñ–∏–ª—å' },
        { href: '/settings/password', label: '–ü–∞—Ä–æ–ª—å' },
        { href: '/settings/billing', label: '–ü–æ–¥–ø–∏—Å–∫–∞' },
        { href: '/settings/schedule/template', label: '–®–∞–±–ª–æ–Ω –Ω–µ–¥–µ–ª–∏' },
      ]})
      sections.push({ title: '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è', items: [
        { href: '/admin/organizations', label: '–ö–æ–º–ø–∞–Ω–∏—è –∏ —Ñ–∏–ª–∏–∞–ª—ã' },
        { href: '/admin/organization/request', label: '–ó–∞—è–≤–∫–∞ –Ω–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é' },
        { href: '/admin/organization/membership', label: '–ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ' },
        { href: '/admin/org-requests', label: '–í—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã' },
      ]})
    } else if (isParent) {
      sections.push({ title: '–ü—Ä–æ—Ñ–∏–ª—å', items: [
        { href: '/settings/profile', label: '–ü—Ä–æ—Ñ–∏–ª—å' },
        { href: '/settings/password', label: '–ü–∞—Ä–æ–ª—å' },
        { href: '/settings/children', label: '–î–µ—Ç–∏' },
      ]})
    }
    return (
      <div data-role={R} className="fixed inset-0 z-30" onClick={() => setMoreOpen(false)}>
        <div className="absolute inset-0 bg-black/30" />
        <div className="absolute inset-x-0 bottom-0 rounded-t-2xl shadow-2xl p-4 space-y-3" style={{ background: 'var(--card-bg)', color: 'var(--card-text)' }} onClick={e=>e.stopPropagation()}>
          <div className="text-center font-semibold text-sm">–ú–µ–Ω—é</div>
          {sections.map((sec)=> (
            <div key={sec.title} className="space-y-1">
              <div className="text-xs text-muted">{sec.title}</div>
              <div className="grid grid-cols-2 gap-2 text-sm">
                {sec.items.map((m)=> (
                  <Link key={m.href} href={m.href} className="btn" onClick={() => setMoreOpen(false)}>
                    {m.label}
                  </Link>
                ))}
              </div>
            </div>
          ))}
          <button className="btn w-full" onClick={() => setMoreOpen(false)}>–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    )
  }

  return (
    <>
      <div data-role={R} className={wrapClass} style={{ background: 'color-mix(in oklab, var(--background) 95%, transparent)', backdropFilter: 'blur(8px)' }}>
        <div className={`grid grid-cols-5`}>
          {{isLogoped {isLogoped && ({isLogoped && ( !showLeader {isLogoped && ({isLogoped && ( !isParent} {isLogoped && ({isLogoped && ( (
            <>
              <Link href="/logoped/schedule" className={linkClass('/logoped/schedule')}>
                <span aria-hidden className="text-[18px] leading-none">üìÖ</span>
                <span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span>
              </Link>
              <Link href="/logoped/clients" className={linkClass('/logoped/clients')}>
                <span aria-hidden className="text-[18px] leading-none">üë•</span>
                <span>–ö–ª–∏–µ–Ω—Ç—ã</span>
              </Link>
              <Link href="/logoped/notifications" className={linkClass('/logoped/notifications')}>
                <span aria-hidden className="text-[18px] leading-none">üîî</span>
                <span>–£–≤–µ–¥–æ–º–ª.</span>
              </Link>
              <Link href="/chat" className={linkClass('/chat')}>
                <span aria-hidden className="text-[18px] leading-none">üí¨</span>
                <span>–ß–∞—Ç</span>
              </Link>
              <button className={commonClass} onClick={()=>setMoreOpen(true)}>
                <span aria-hidden className="text-[18px] leading-none">‚ãØ</span>
                <span>–ú–µ–Ω—é</span>
              </button>
            </>
          )}

          {{showLeader {showLeader && ({showLeader && ( !isParent} {showLeader && ({showLeader && ( (
            <>
              <Link href="/settings/schedule" className={linkClass('/settings/schedule')}>
                <span aria-hidden className="text-[18px] leading-none">üìÖ</span>
                <span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span>
              </Link>
              <Link href="/admin/clients" className={linkClass('/admin/clients')}>
                <span aria-hidden className="text-[18px] leading-none">üë•</span>
                <span>–ö–ª–∏–µ–Ω—Ç—ã</span>
              </Link>
              <Link href="/settings/notifications" className={linkClass('/settings/notifications')}>
                <span aria-hidden className="text-[18px] leading-none">üîî</span>
                <span>–£–≤–µ–¥–æ–º–ª.</span>
              </Link>
              <Link href="/chat" className={linkClass('/chat')}>
                <span aria-hidden className="text-[18px] leading-none">üí¨</span>
                <span>–ß–∞—Ç</span>
              </Link>
              <button className={commonClass} onClick={()=>setMoreOpen(true)}>
                <span aria-hidden className="text-[18px] leading-none">‚ãØ</span>
                <span>–ú–µ–Ω—é</span>
              </button>
            </>
          )}

          {isParent && (
            <>
              <Link href="/parent/lessons" className={linkClass('/parent/lessons')}>
                <span aria-hidden className="text-[18px] leading-none">üìÖ</span>
                <span>–ó–∞–Ω—è—Ç–∏—è</span>
              </Link>
              <Link href="/parent/enrollments" className={linkClass('/parent/enrollments')}>
                <span aria-hidden className="text-[18px] leading-none">üìù</span>
                <span>–ó–∞–ø–∏—Å—å</span>
              </Link>
              <Link href="/parent/logopeds" className={linkClass('/parent/logopeds')}>
                <span aria-hidden className="text-[18px] leading-none">üßë‚Äç‚öïÔ∏è</span>
                <span>–õ–æ–≥–æ–ø–µ–¥—ã</span>
              </Link>
              <Link href="/chat" className={linkClass('/chat')}>
                <span aria-hidden className="text-[18px] leading-none">üí¨</span>
                <span>–ß–∞—Ç</span>
              </Link>
              <button className={commonClass} onClick={()=>setMoreOpen(true)}>
                <span aria-hidden className="text-[18px] leading-none">‚ãØ</span>
                <span>–ú–µ–Ω—é</span>
              </button>
            </>
          )}
        </div>
      </div>
      {moreOpen && <MenuPanel />}
    </>
  )
}
