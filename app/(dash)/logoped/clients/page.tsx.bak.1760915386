import { getServerSession } from 'next-auth'
import { authOptions } from '@/lib/auth'
import { prisma } from '@/lib/prisma'
import Link from 'next/link'
import crypto from 'crypto'
import ParentPassword from '@/components/ParentPassword'
import LogopedPreviewTrigger from '@/components/LogopedPreview'
import { archiveChild, restoreChild, approveActivation, rejectActivation, createParentAndChild, createChildForExistingParent, attachExistingChildToMe, searchParent, transferChildInsideOrg, requestTransferByEmail, approveTransferRequest, rejectTransferRequest, regenerateParentPassword } from './actions'
import { startChat } from '../../../chat/actions'
import { getOrCreateConversation } from '../../../chat/chatService'
export const dynamic = 'force-dynamic'
export const revalidate = 0

export default async function LogopedClientsPage({ searchParams }: { searchParams: Promise<{ tab?: string; q?: string; search?: string; op?: string; child?: string; parent?: string; activation?: string; archived?: string; restored?: string; transfer?: string }> }) {
  const sp = await searchParams
  const session = await getServerSession(authOptions)
  const role = (session?.user as any)?.role
  if (!session || !['LOGOPED','ADMIN','SUPER_ADMIN'].includes(role)) return <div>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</div>

  const currentLogopedId = (session.user as any).id as string
  const tab = sp?.tab || 'active'
  const q = (sp?.q || '').trim()
  const activationState = sp?.activation
  const archivedState = sp?.archived
  const restoredState = sp?.restored
  const opState = sp?.op
  const transferState = sp?.transfer
  const searchEmail = sp?.search ? String(sp.search).toLowerCase().trim() : ''
  const childQuery = sp?.child ? String(sp.child).trim() : ''
  const parentQuery = sp?.parent ? String(sp.parent).trim() : ''

  const activationRequests = await (prisma as any).activationRequest.findMany({
    where: { targetLogopedId: currentLogopedId, status: 'PENDING' },
    include: { parent: { include: { user: true, children: true } } },
    orderBy: { createdAt: 'desc' },
  })

  

  // –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è –ø–æ email (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω searchEmail)
  let foundParent: any = null
  if (searchEmail) {
    const user = await (prisma as any).user.findUnique({ where: { email: searchEmail } })
    if (user && user.role === 'PARENT') {
      foundParent = await (prisma as any).parent.findUnique({ where: { userId: user.id }, include: { user: true, children: true } })
    }
  }

  // –ò—Å—Ç–æ—Ä–∏—é –∑–∞—è–≤–æ–∫ –ø–µ—Ä–µ–Ω–µ—Å–ª–∏ –≤ –¶–µ–Ω—Ç—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

  // –ê–∫—Ç–∏–≤–Ω—ã–µ: —Ç–æ–ª—å–∫–æ –≤–∞—à–∏ –∏ –Ω–µ –≤ –∞—Ä—Ö–∏–≤–µ
  const active = await (prisma as any).child.findMany({
    where: { logopedId: currentLogopedId, isArchived: false },
    orderBy: [{ lastName: 'asc' }],
    include: { parent: { include: { user: true } } },
  })
  // –õ–æ–≥–æ–ø–µ–¥—ã –º–æ–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (–¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞ –≤–Ω—É—Ç—Ä–∏ –æ—Ä–≥)
  const me = await (prisma as any).user.findUnique({ where: { id: currentLogopedId }, include: { branch: { include: { company: true } } } })
  const companyId = me?.branch?.companyId || null
  const orgLogopeds = companyId ? await (prisma as any).user.findMany({ where: { role: 'LOGOPED', id: { not: currentLogopedId }, branch: { companyId } }, orderBy: { name: 'asc' } }) : []
  // –í—Ö–æ–¥—è—â–∏–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–µ—Ä–µ–¥–∞—á—É —Ä–µ–±—ë–Ω–∫–∞ (–¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ –ö–ª–∏–µ–Ω—Ç—ã)
  const incomingTransfers = await ((prisma as any).transferRequest?.findMany
    ? (prisma as any).transferRequest.findMany({ where: { toLogopedId: currentLogopedId, status: 'PENDING' }, orderBy: { createdAt: 'desc' } })
    : Promise.resolve([])) as any[]
  const getAge = (birthDate?: string | Date | null) => {
    if (!birthDate) return null
    const d = new Date(birthDate as any)
    if (isNaN(d.getTime())) return null
    const now = new Date()
    let age = now.getFullYear() - d.getFullYear()
    const m = now.getMonth() - d.getMonth()
    if (m < 0 || (m === 0 && now.getDate() < d.getDate())) age--
    return age
  }
  const decryptVisiblePassword = (enc?: string | null): string | null => {
    try {
      if (!enc) return null
      if (enc.startsWith('plain:')) {
        const b64 = enc.slice(6)
        return Buffer.from(b64, 'base64').toString('utf8')
      }
      const rawKey = process.env.PARENT_PWD_KEY || ''
      if (!rawKey) return null
      const buf = Buffer.from(enc, 'base64')
      if (buf.length < 12 + 16 + 1) return null
      const iv = buf.subarray(0, 12)
      const tag = buf.subarray(12, 28)
      const data = buf.subarray(28)
      const key = Buffer.from(rawKey.padEnd(32, '0').slice(0, 32))
      const decipher = crypto.createDecipheriv('aes-256-gcm', key, iv)
      decipher.setAuthTag(tag)
      const dec = Buffer.concat([decipher.update(data), decipher.final()])
      return dec.toString('utf8')
    } catch {
      return null
    }
  }
  let activeFiltered = active as any[]
  if (childQuery) {
    activeFiltered = activeFiltered.filter(c => String(c.lastName || '').toLowerCase().includes(childQuery.toLowerCase()))
  }
  if (parentQuery) {
    const ql = parentQuery.toLowerCase()
    activeFiltered = activeFiltered.filter(c => {
      const n = String(c.parent?.user?.name || '').toLowerCase()
      const e = String(c.parent?.user?.email || '').toLowerCase()
      const fn = String(c.parent?.fullName || '').toLowerCase()
      return n.includes(ql) || e.includes(ql) || fn.includes(ql)
    })
  }

  // –ê—Ä—Ö–∏–≤: –ø–æ –∑–∞–ø—Ä–æ—Å—É –§–ò–û —Ä–æ–¥–∏—Ç–µ–ª—è (fullName –∏–ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è), –≤–∏–¥–µ–Ω –≤—Å–µ–º –ª–æ–≥–æ–ø–µ–¥–∞–º
  const archived = await (prisma as any).child.findMany({
    where: {
      isArchived: true,
      parent: {
        isArchived: true,
        ...(q ? { OR: [
          { fullName: { contains: q, mode: 'insensitive' } },
          { user: { name: { contains: q, mode: 'insensitive' } } },
          { user: { email: { contains: q, mode: 'insensitive' } } },
        ] } : {}),
      },
    },
    orderBy: [{ lastName: 'asc' }],
    include: { parent: { include: { user: true } } },
  })

  // –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º convId –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö —Å—Å—ã–ª–æ–∫ –≤ —á–∞—Ç (—á—Ç–æ–±—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å /chat?to=...)
  const convByActiveChild: Record<string, string> = {}
  const convByArchivedParent: Record<string, string> = {}
  // active children ‚Üí conversation with their parent
  for (const ch of active as any[]) {
    const parentUserId = ch.parent?.user?.id
    if (parentUserId) {
      const conv = await getOrCreateConversation(currentLogopedId, String(parentUserId), String(ch.id))
      if (conv?.id) convByActiveChild[String(ch.id)] = String(conv.id)
    }
  }
  // archived children ‚Üí generic conversation with parent
  for (const ch of archived as any[]) {
    const parentUserId = ch.parent?.user?.id
    if (parentUserId && !convByArchivedParent[parentUserId]) {
      const conv = await getOrCreateConversation(currentLogopedId, String(parentUserId))
      if (conv?.id) convByArchivedParent[parentUserId] = String(conv.id)
    }
  }

  return (
    <div className="container space-y-6 py-6">
      {(activationState || archivedState || restoredState || opState || transferState) && (
        <div className="rounded border p-3 bg-emerald-50 text-emerald-800">
          {activationState==='approved' && <div>–ó–∞—è–≤–∫–∞ –Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—é ‚Äî –æ–¥–æ–±—Ä–µ–Ω–∞.</div>}
          {activationState==='rejected' && <div className="text-amber-800">–ó–∞—è–≤–∫–∞ –Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—é ‚Äî –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.</div>}
          {archivedState && <div>–ö–∞—Ä—Ç–æ—á–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤ –∞—Ä—Ö–∏–≤.</div>}
          {restoredState && <div>–ö–∞—Ä—Ç–æ—á–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ –∞—Ä—Ö–∏–≤–∞.</div>}
          {opState==='created' && <div>–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Ä–æ–¥–∏—Ç–µ–ª—å –∏ —Ä–µ–±—ë–Ω–æ–∫.</div>}
          {opState==='child_created' && <div>–°–æ–∑–¥–∞–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ —Ä–µ–±—ë–Ω–∫–∞ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è.</div>}
          {opState==='attached' && <div>–†–µ–±—ë–Ω–æ–∫ –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω –∫ –≤–∞–º.</div>}
          {transferState==='done' && <div>–ü–µ—Ä–µ–¥–∞—á–∞ –≤–Ω—É—Ç—Ä–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.</div>}
          {transferState==='requested' && <div>–ó–∞–ø—Ä–æ—Å –Ω–∞ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä –ø–æ email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.</div>}
          {transferState==='approved' && <div>–¢—Ä–∞–Ω—Å—Ñ–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω.</div>}
        </div>
      )}

      

      

      

      

      

      {/* –ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ ¬´–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è¬ª */}
      <div className="flex gap-2">
        <a href="?tab=active" className={`btn text-sm ${tab==='active'?'btn-secondary':''}`}>–ê–∫—Ç–∏–≤–Ω—ã–µ</a>
        <a href="?tab=archive" className={`btn text-sm ${tab==='archive'?'btn-secondary':''}`}>–ê—Ä—Ö–∏–≤</a>
      </div>

      {(activationRequests.length > 0 || incomingTransfers.length > 0) && (
        <section className="section">
          <h2 className="mb-3 text-lg font-semibold">–ó–∞–ø—Ä–æ—Å—ã</h2>
          <div className="space-y-2">
            {incomingTransfers.length > 0 && (
              <div className="rounded border p-3" style={{ background: 'var(--card-bg)' }}>
                <div className="font-medium mb-2">–ü–µ—Ä–µ–¥–∞—á–∏ –¥–µ—Ç–µ–π</div>
                <div className="space-y-2">
                  {incomingTransfers.map((r:any)=> (
                    <div key={r.id} className="flex items-center justify-between p-2 rounded-md border">
                      <div className="text-sm">
                        <div className="font-medium">–†–µ–±—ë–Ω–æ–∫ ID: {r.childId}</div>
                        <div className="text-xs text-muted">–û—Ç –ª–æ–≥–æ–ø–µ–¥–∞ ID: {r.fromLogopedId} ¬∑ {new Date(r.createdAt).toLocaleString('ru-RU')}</div>
                      </div>
                      <div className="flex gap-2">
                        <form action={approveTransferRequest}>
                          <input type="hidden" name="requestId" value={r.id} />
                          <button className="btn btn-secondary btn-sm">–ü—Ä–∏–Ω—è—Ç—å</button>
                        </form>
                        <form action={rejectTransferRequest}>
                          <input type="hidden" name="requestId" value={r.id} />
                          <button className="btn btn-danger btn-sm">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                        </form>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
            {activationRequests.length > 0 && (
              <div className="rounded border p-3" style={{ background: 'var(--card-bg)' }}>
                <h3 className="font-medium mb-2">–ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—é</h3>
                <div className="space-y-2">
                  {activationRequests.map((r: any) => (
                    <div key={r.id} className="flex flex-col gap-2 p-3 rounded-md border shadow-sm sm:flex-row sm:items-center sm:justify-between" style={{ background: 'var(--card-bg)' }}>
                      <div>
                        <div className="font-medium">{r.parent.user.name || r.parent.user.email}</div>
                        <div className="text-sm text-muted">–î–µ—Ç–µ–π: {r.parent.children.length}</div>
                        {r.note && <div className="text-xs text-muted mt-1">–°–æ–æ–±—â–µ–Ω–∏–µ: {r.note}</div>}
                      </div>
                      <div className="flex gap-2">
                        <form action={approveActivation}>
                          <input type="hidden" name="requestId" value={r.id} />
                          <button className="btn btn-secondary text-sm">–ü—Ä–∏–Ω—è—Ç—å</button>
                        </form>
                        <form action={rejectActivation}>
                          <input type="hidden" name="requestId" value={r.id} />
                          <button className="btn btn-danger text-sm">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                        </form>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </section>
      )}


      


      

      

      

      {tab==='active' && (
        <section className="section">
          <h2 className="mb-3 text-lg font-semibold">–ê–∫—Ç–∏–≤–Ω—ã–µ</h2>
          <div className="mb-3 flex items-end justify-between gap-2">
            <form method="get" className="flex items-end gap-2">
              <input type="hidden" name="tab" value="active" />
              <div>
                <label className="block text-sm mb-1">–ü–æ–∏—Å–∫ –ø–æ —Ñ–∞–º–∏–ª–∏–∏ —Ä–µ–±—ë–Ω–∫–∞</label>
                <input name="child" defaultValue={childQuery} className="input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω–æ–≤" />
              </div>
              <div>
                <label className="block text-sm mb-1">–ü–æ–∏—Å–∫ –ø–æ —Ä–æ–¥–∏—Ç–µ–ª—é (–§–ò–û / email)</label>
                <input name="parent" defaultValue={parentQuery} className="input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–µ—Ç—Ä–æ–≤–∞ / user@mail.ru" />
              </div>
              <button className="btn">–ò—Å–∫–∞—Ç—å</button>
            </form>
            <a href="/logoped/clients/export" className="btn btn-secondary">–≠–∫—Å–ø–æ—Ä—Ç CSV</a>
          </div>
          <div className="space-y-2">
            {activeFiltered.length === 0 && <div className="text-sm text-muted">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>}
            {activeFiltered.map((ch: any) => (
              <div key={ch.id} className="flex flex-col sm:flex-row sm:items-start sm:justify-between p-3 gap-4 rounded-md border shadow-sm hover:bg-gray-50" style={{ background: 'var(--card-bg)' }}>
                <div className="flex items-start gap-3">
                  <LogopedPreviewTrigger name={`${ch.lastName} ${ch.firstName}`} image={ch.photoUrl} subtitleLines={[getAge(ch.birthDate)!=null?`–í–æ–∑—Ä–∞—Å—Ç: ${getAge(ch.birthDate)} –ª–µ—Ç`:'']} actionHref={`/chat/${convByActiveChild[ch.id] || ''}`} actionLabel="–ù–∞–ø–∏—Å–∞—Ç—å">
                    {ch.photoUrl ? (
                      <img src={ch.photoUrl} alt={ch.firstName} className="h-12 w-12 rounded-md object-cover" />
                    ) : (
                      <div className="h-12 w-12 rounded-md bg-gray-200 text-[10px] text-muted flex items-center justify-center">–ù–µ—Ç —Ñ–æ—Ç–æ</div>
                    )}
                  </LogopedPreviewTrigger>
                  <div>
                    <LogopedPreviewTrigger name={`${ch.lastName} ${ch.firstName}`} image={ch.photoUrl} subtitleLines={[getAge(ch.birthDate)!=null?`–í–æ–∑—Ä–∞—Å—Ç: ${getAge(ch.birthDate)} –ª–µ—Ç`:'']} actionHref={`/chat/${convByActiveChild[ch.id] || ''}`} actionLabel="–ù–∞–ø–∏—Å–∞—Ç—å">
                      <div className="font-medium cursor-pointer">{ch.lastName} {ch.firstName}</div>
                    </LogopedPreviewTrigger>
                    <div className="text-sm text-muted">
                      –†–æ–¥–∏—Ç–µ–ª—å: {' '}
                      <LogopedPreviewTrigger name={(ch.parent as any).fullName || ch.parent.user.name || ch.parent.user.email} image={(ch.parent.user as any)?.image} phone={(ch.parent as any)?.phone} phone={(ch.parent as any)?.phone} subtitleLines={[((ch.parent as any)?.phone ? `–¢–µ–ª–µ—Ñ–æ–Ω: ${(ch.parent as any).phone}` : '')]} actionHref={`/chat/${convByActiveChild[ch.id] || ''}`} actionLabel="–ù–∞–ø–∏—Å–∞—Ç—å">
                        <span className="underline cursor-pointer truncate max-w-[180px] inline-block align-bottom" title={(ch.parent as any).fullName || ch.parent.user.name || ch.parent.user.email}>{(ch.parent as any).fullName || ch.parent.user.name || ''}</span>
                      </LogopedPreviewTrigger>
                    </div>
                  </div>
                </div>
                <div className="flex flex-col sm:items-end gap-2 sm:min-w-[320px] w-full">
                  <div className="grid grid-cols-2 sm:flex sm:flex-row gap-2 w-full sm:w-auto">
                    <Link className="btn btn-sm w-full sm:w-auto" href={`/logoped/child/${ch.id}`}>üìÑ –û—Ç–∫—Ä—ã—Ç—å</Link>
                    <form action={archiveChild}>
                      <input type="hidden" name="childId" value={ch.id} />
                      <button className="btn btn-danger btn-sm w-full sm:w-auto">üóÇÔ∏è –í –∞—Ä—Ö–∏–≤</button>
                    </form>
                    <Link href={`/chat/${convByActiveChild[ch.id] || ''}`} className="btn btn-sm w-full sm:w-auto">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å</Link>
                  </div>
                  {/* –£–±—Ä–∞–Ω–æ: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –µ—â—ë –æ–¥–Ω–æ–≥–æ —Ä–µ–±—ë–Ω–∫–∞ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö */}
                  {/* –ü–µ—Ä–µ–¥–∞—á–∞ —Ä–µ–±—ë–Ω–∫–∞ */}
                  <details className="w-full">
                    <summary className="text-xs text-muted cursor-pointer">–ü–µ—Ä–µ–¥–∞—á–∞ —Ä–µ–±—ë–Ω–∫–∞</summary>
                    <div className="mt-2 grid gap-3">
                      <form action={transferChildInsideOrg} className="flex items-end gap-2">
                        <input type="hidden" name="childId" value={ch.id} />
                        <label className="grid gap-1">
                          <span className="text-xs">–õ–æ–≥–æ–ø–µ–¥ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</span>
                          <select name="toLogopedId" className="input !py-2 !px-2" disabled={!companyId}>
                            {orgLogopeds.map((u:any)=> (
                              <option key={u.id} value={u.id}>{u.name || u.email}</option>
                            ))}
                          </select>
                        </label>
                        <button className="btn btn-secondary btn-sm" disabled={!companyId || orgLogopeds.length===0}>–ü–µ—Ä–µ–¥–∞—Ç—å</button>
                      </form>
                      <form action={requestTransferByEmail} className="flex items-end gap-2">
                        <input type="hidden" name="childId" value={ch.id} />
                        <label className="grid gap-1">
                          <span className="text-xs">E-mail –ª–æ–≥–æ–ø–µ–¥–∞ (–≤ —Ç.—á. –¥—Ä—É–≥–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è)</span>
                          <input name="email" type="email" className="input" placeholder="logoped@domain.ru" required />
                        </label>
                        <button className="btn btn-primary btn-sm">–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä</button>
                      </form>
                    </div>
                  </details>
                </div>
              </div>
            ))}
          </div>
        </section>
      )}

      {tab==='archive' && (
        <section className="section">
          <div className="mb-3 flex items-end justify-between gap-2">
            <h2 className="text-lg font-semibold">–ê—Ä—Ö–∏–≤</h2>
            <form method="get" className="flex items-end gap-2">
              <input type="hidden" name="tab" value="archive" />
              <div>
                <label className="block text-sm mb-1">–ü–æ–∏—Å–∫ –ø–æ –§–ò–û/email —Ä–æ–¥–∏—Ç–µ–ª—è</label>
                <input name="q" defaultValue={q} className="input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω–æ–≤–∞ –ê–Ω–Ω–∞" />
              </div>
              <button className="btn">–ò—Å–∫–∞—Ç—å</button>
            </form>
          </div>
          <div className="space-y-2">
            {archived.length === 0 && <div className="text-sm text-muted">–í –∞—Ä—Ö–∏–≤–µ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>}
            {archived.map((ch: any) => (
              <div key={ch.id} className="flex flex-col sm:flex-row sm:items-center sm:justify-between p-3 gap-3 rounded-md border shadow-sm" style={{ background: 'var(--card-bg)' }}>
                <div className="flex items-center gap-3">
                  <LogopedPreviewTrigger name={`${ch.lastName} ${ch.firstName}`} image={ch.photoUrl} subtitleLines={[getAge(ch.birthDate)!=null?`–í–æ–∑—Ä–∞—Å—Ç: ${getAge(ch.birthDate)} –ª–µ—Ç`:'']} actionHref={`/chat/${convByArchivedParent[ch.parent.user.id] || ''}`} actionLabel="–ù–∞–ø–∏—Å–∞—Ç—å">
                    {ch.photoUrl ? (
                      <img src={ch.photoUrl} alt={ch.firstName} className="h-10 w-10 rounded-md object-cover" />
                    ) : (
                      <div className="h-10 w-10 rounded-md bg-gray-200 text-[10px] text-muted flex items-center justify-center">–ù–µ—Ç —Ñ–æ—Ç–æ</div>
                    )}
                  </LogopedPreviewTrigger>
                  <div>
                    <LogopedPreviewTrigger name={`${ch.lastName} ${ch.firstName}`} image={ch.photoUrl} subtitleLines={[getAge(ch.birthDate)!=null?`–í–æ–∑—Ä–∞—Å—Ç: ${getAge(ch.birthDate)} –ª–µ—Ç`:'']} actionHref={`/chat/${convByArchivedParent[ch.parent.user.id] || ''}`} actionLabel="–ù–∞–ø–∏—Å–∞—Ç—å">
                      <div className="font-medium cursor-pointer">{ch.lastName} {ch.firstName}</div>
                    </LogopedPreviewTrigger>
                    <div className="text-sm text-muted">
                      –†–æ–¥–∏—Ç–µ–ª—å: {' '}
                      <LogopedPreviewTrigger name={(ch.parent as any).fullName || ch.parent.user.name || ch.parent.user.email} image={(ch.parent.user as any)?.image} phone={(ch.parent as any)?.phone} phone={(ch.parent as any)?.phone} subtitleLines={[((ch.parent as any)?.phone ? `–¢–µ–ª–µ—Ñ–æ–Ω: ${(ch.parent as any).phone}` : '')]} actionHref={`/chat/${convByArchivedParent[ch.parent.user.id] || ''}`} actionLabel="–ù–∞–ø–∏—Å–∞—Ç—å">
                        <span className="underline cursor-pointer truncate max-w-[180px] inline-block align-bottom" title={(ch.parent as any).fullName || ch.parent.user.name || ch.parent.user.email}>{(ch.parent as any).fullName || ch.parent.user.name || ''}</span>
                      </LogopedPreviewTrigger>
                    </div>
                  </div>
                </div>
                <div className="w-full sm:w-auto">
                  <div className="grid grid-cols-2 sm:flex sm:flex-row gap-2 w-full sm:w-auto">
                    <form action={restoreChild} className="col-span-2 sm:col-span-1">
                      <input type="hidden" name="childId" value={ch.id} />
                      <button className="btn btn-secondary btn-sm w-full sm:w-auto">‚Ü©Ô∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                    </form>
                    <Link href={`/chat/${convByArchivedParent[ch.parent.user.id] || ''}`} className="btn btn-sm w-full sm:w-auto">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å</Link>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </section>
      )}
      {/* –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è: —Å–æ–∑–¥–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è+—Ä–µ–±—ë–Ω–∫–∞, –Ω–∞–π—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è */}
      <section className="section">
        <h2 className="mb-3 text-lg font-semibold">–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</h2>
        <div className="grid gap-6 lg:grid-cols-2">
          <div className="rounded border p-3" style={{ background: 'var(--card-bg)' }}>
            <h3 className="font-medium mb-2">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è –∏ —Ä–µ–±—ë–Ω–∫–∞</h3>
            <form action={createParentAndChild} className="grid gap-2">
              <div className="grid sm:grid-cols-2 gap-2">
                <input name="email" type="email" className="input" placeholder="E-mail —Ä–æ–¥–∏—Ç–µ–ª—è" required />
                <input name="phone" className="input" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–æ–ø—Ü.)" />
              </div>
              <input name="fullName" className="input" placeholder="–§–ò–û —Ä–æ–¥–∏—Ç–µ–ª—è (–æ–ø—Ü.)" />
              <div className="grid sm:grid-cols-2 gap-2">
                <input name="childLastName" className="input" placeholder="–§–∞–º–∏–ª–∏—è —Ä–µ–±—ë–Ω–∫–∞" required />
                <input name="childFirstName" className="input" placeholder="–ò–º—è —Ä–µ–±—ë–Ω–∫–∞" required />
              </div>
              <button className="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
            </form>
          </div>
          <div className="rounded border p-3" style={{ background: 'var(--card-bg)' }}>
            <h3 className="font-medium mb-2">–ù–∞–π—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è</h3>
            <form action={searchParent} className="flex gap-2">
              <input name="email" type="email" defaultValue={searchEmail} className="input" placeholder="E-mail —Ä–æ–¥–∏—Ç–µ–ª—è" required />
              <button className="btn">–ù–∞–π—Ç–∏</button>
            </form>
            {searchEmail && (
              <div className="mt-3 text-sm">
                <div className="text-muted">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è: {searchEmail}</div>
                {!foundParent && <div className="text-amber-700">–†–æ–¥–∏—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</div>}
                {foundParent && (
                  <div className="mt-3 space-y-3">
                    <div className="font-medium">{foundParent.fullName || foundParent.user.name || foundParent.user.email}</div>
                    <div className="text-xs text-muted">–°—Ç–∞—Ç—É—Å: {foundParent.isArchived ? '–≤ –∞—Ä—Ö–∏–≤–µ' : '–∞–∫—Ç–∏–≤–µ–Ω'}</div>
                    <div className="rounded border p-2">
                      <div className="text-sm font-medium mb-2">–°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É —Ä–µ–±—ë–Ω–∫–∞</div>
                      <form action={createChildForExistingParent} className="grid gap-2">
                        <input type="hidden" name="email" value={foundParent.user.email} />
                        <div className="grid sm:grid-cols-2 gap-2">
                          <input name="childLastName" className="input" placeholder="–§–∞–º–∏–ª–∏—è —Ä–µ–±—ë–Ω–∫–∞" required />
                          <input name="childFirstName" className="input" placeholder="–ò–º—è —Ä–µ–±—ë–Ω–∫–∞" required />
                        </div>
                        <button className="btn btn-secondary">–°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É</button>
                      </form>
                    </div>
                    <div className="rounded border p-2">
                      <div className="text-sm font-medium mb-2">–î–µ—Ç–∏ —Ä–æ–¥–∏—Ç–µ–ª—è</div>
                      <div className="space-y-2">
                        {foundParent.children.length === 0 && (
                          <div className="text-xs text-muted py-1">–£ —Ä–æ–¥–∏—Ç–µ–ª—è –ø–æ–∫–∞ –Ω–µ—Ç –¥–µ—Ç–µ–π</div>
                        )}
                        {foundParent.children.map((c: any) => (
                          <div key={c.id} className="flex items-center justify-between p-3 text-sm rounded-md border shadow-sm" style={{ background: 'var(--card-bg)' }}>
                            <div>
                              <div className="font-medium">{c.lastName} {c.firstName}</div>
                              <div className="text-xs text-muted">{c.isArchived ? '–í –∞—Ä—Ö–∏–≤–µ' : '–ê–∫—Ç–∏–≤–µ–Ω'} ¬∑ {c.logopedId ? (c.logopedId===currentLogopedId ? '–í–∞—à –∫–ª–∏–µ–Ω—Ç' : '–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω –∫ –¥—Ä—É–≥–æ–º—É –ª–æ–≥–æ–ø–µ–¥—É') : '–ë–µ–∑ –ª–æ–≥–æ–ø–µ–¥–∞'}</div>
                            </div>
                            <div>
                              <div className="flex gap-2">
                                {(!c.logopedId || c.logopedId!==currentLogopedId) && (
                                  <form action={attachExistingChildToMe}>
                                    <input type="hidden" name="childId" value={c.id} />
                                    <button className="btn btn-sm">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å</button>
                                  </form>
                                )}
                                <form action={startChat}>
                                  <input type="hidden" name="targetUserId" value={foundParent.user.id} />
                                  <button className="btn btn-sm">–ù–∞–ø–∏—Å–∞—Ç—å</button>
                                </form>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      </section>

    </div>
  )

}